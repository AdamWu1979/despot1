# despot1:  DESPOT1-HIFI T1 mapping BIDS app


## Inputs:
Example BIDS-like naming (acq- flag and DESPOT suffix are *required*):
 sub-01/anat/sub-01_acq-SPGR_flip-1_DESPOT.nii.gz
 sub-01/anat/sub-01_acq-SPGR_flip-2_DESPOT.nii.gz
 sub-01/anat/sub-01_acq-IRSPGR_DESPOT.nii.gz

The SPGR json files must include:
 - RepetitionTime
 - FlipAngle

The IRSPGR json files must include:
 - RepetitionTime
 - InversionTime
 - FlipAngle

The following variables are hardcoded in run.sh (need to be modified if they are different for your sequence):
```
npulse=78  #readout pulses following inversion
field=3  #field strength
invmode=2  #number of inversions per slice
```

##  Overall pipeline:
 - Parse and extract parameters from JSON files 
 - Rigidly register images to the first SPGR (flirt)
 - Pre-process images prior to C code (nifti -> analyze)
 - Run DESPOT1-HIFI fitting using pre-compiled C code (src from Sean Deoni)
 - Post-process T1map, B1map, M0map images after C code (analyze -> nifti)
 - Generate synthetic T1w map (simple octave script)
 - Generate hard and soft brain masks from M0map
   - Hard mask from bet
   - Soft mask generated by N4 on bet M0map, then 10th percentile cutoff (hard above, 0-1 below)
 - Apply soft mask to T1map, T1w, and B1map (to downweight high-intensity boundary voxels), and hard mask to M0map
 
 ## Output:
 ```
── OUT_FOLDER
    └── sub-P004
        └── anat
            ├── sub-P004_acq-DESPOT_B1map.nii.gz
            ├── sub-P004_acq-DESPOT_M0map.nii.gz
            ├── sub-P004_acq-DESPOT_proc-masked_B1map.nii.gz
            ├── sub-P004_acq-DESPOT_proc-masked_M0map.nii.gz
            ├── sub-P004_acq-DESPOT_proc-masked_T1map.nii.gz
            ├── sub-P004_acq-DESPOT_proc-masked_T1w.nii.gz
            ├── sub-P004_acq-DESPOT_T1map.nii.gz
            └── sub-P004_acq-DESPOT_T1w.nii.gz
```

An `work` folder with intermediate files will also be generated
 
To do:
 - similar app for DESPOT2-FM mapping..
 
